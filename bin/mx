#!/usr/bin/env bash

# mx

set -o errexit
set -o nounset

# Are we in a tmux session?
if [[ -v TMUX ]]; then
  inside_tmux_session=1
  TMUX= # clear out the TMUX variable locally so we can create (non-nested) sessions
else
  inside_tmux_session=0
fi
readonly inside_tmux_session

# What session do we want to connect to?
if [[ $# = 0 ]]; then
  session="$(basename $PWD)"
elif [[ -d $1 ]]; then
  session="$(basename $1)"
  session_path=$1
else
  session=$1
fi
readonly session="$(echo $session | tr . _)"

# How should we use the tmux command?
readonly tmux_cmd="tmux -2"

# Create the session, if it doesn't already exist
if ! ($tmux_cmd list-sessions | cut -d':' -f1 | grep -q ^"$session"\$); then
  if [[ -v session_path ]]; then
    cd $session_path
  elif [[ -d "$PROJECTS"/"$session" ]]; then
    cd "$PROJECTS"/"$session"
  fi

  if [[ -x "$PWD"/.tmux ]]; then
    "$PWD"/.tmux "$session"
  else
    $tmux_cmd new-session -s "$session" -n editor -d
    $tmux_cmd send-keys -t "$session" "$EDITOR" C-m
    $tmux_cmd new-window -n shell -t "$session"

    $tmux_cmd select-window -t "$session":1
  fi
fi

# Connect to the session
if [[ $inside_tmux_session = 1 ]]; then
  $tmux_cmd switch-client -t "$session"
else
  $tmux_cmd attach -t "$session"
fi
